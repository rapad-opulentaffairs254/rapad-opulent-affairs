<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard - Rapad Opulent Affairs</title>
  <link rel="stylesheet" href="style.css" />
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  collection,
  getDocs,
  updateDoc,
  addDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCCZ5h5moCnPdVq6zXQYHhx7FcUsZHnhgk",
  authDomain: "rapad-employee-portal.firebaseapp.com",
  projectId: "rapad-employee-portal",
  storageBucket: "rapad-employee-portal.appspot.com",
  messagingSenderId: "276746044900",
  appId: "1:276746044900:web:4cf1ab62c98ba85d5c33f1",
  measurementId: "G-L54YK0VXC8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const employeesList = document.getElementById("employeesList");
const scheduleSelect = document.getElementById("employeeSelectSchedule");
const leaveSelect = document.getElementById("employeeSelectLeave");
const dutySelect = document.getElementById("employeeSelectDuty");

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "employee-portal.html";
    return;
  }

  const docRef = doc(db, "users", user.uid);
  const docSnap = await getDoc(docRef);

  if (!docSnap.exists() || docSnap.data().role !== "admin") {
    alert("Access denied. Admins only.");
    window.location.href = "employee-portal.html";
    return;
  }

  const employeesSnapshot = await getDocs(collection(db, "users"));
  employeesList.innerHTML = "";

  for (const docData of employeesSnapshot.docs) {
    const data = docData.data();

    const empDiv = document.createElement("div");
    empDiv.innerHTML = `
      <p><strong>${data.name}</strong> (${data.position}) - ${data.email} <br/>
      Status: ${data.approved ? "✅ Approved" : "❌ Not Approved"}
      ${!data.approved ? `<button data-id="${docData.id}" class="approve-btn">Approve</button>` : ""}</p>
      <hr>
    `;
    employeesList.appendChild(empDiv);

    if (data.approved) {
      const option = new Option(data.name, docData.id);
      scheduleSelect.add(option.cloneNode(true));
      leaveSelect.add(option.cloneNode(true));
      dutySelect.add(option.cloneNode(true));
    }
  }

  // ✅ Reports
  const reportsContainer = document.getElementById("reportsContainer");
  const reportsSnapshot = await getDocs(collection(db, "reports"));
  reportsContainer.innerHTML = "";
  for (const doc of reportsSnapshot.docs) {
    const data = doc.data();
    const reportDiv = document.createElement("div");
    reportDiv.innerHTML = `
      <p><strong>${data.employeeName || 'Unknown Employee'}</strong></p>
      <p>${data.text}</p>
      <hr>`;
    reportsContainer.appendChild(reportDiv);
  }

  // ✅ Leave Requests
  const leaveRequestsContainer = document.getElementById("leaveRequestsContainer");
  const leaveSnapshot = await getDocs(collection(db, "leaveRequests"));
  leaveRequestsContainer.innerHTML = "";
  for (const doc of leaveSnapshot.docs) {
    const data = doc.data();
    const leaveDiv = document.createElement("div");
    leaveDiv.innerHTML = `
      <p><strong>${data.employeeName || 'Unknown Employee'}</strong> - ${data.type}</p>
      <p>From ${data.date} <br> Reason: ${data.reason}</p>
      <p>Status: ${data.approved ? "✅ Approved" : "❌ Pending"}</p>
      ${!data.approved ? `<button class="approve-leave-btn" data-id="${doc.id}">Approve</button>` : ""}
      <hr>`;
    leaveRequestsContainer.appendChild(leaveDiv);
  }

  // ✅ Task Feedback
  const taskFeedbackContainer = document.getElementById("taskFeedbackContainer");
  const feedbackSnapshot = await getDocs(collection(db, "taskFeedback"));
  taskFeedbackContainer.innerHTML = "";
  for (const doc of feedbackSnapshot.docs) {
    const data = doc.data();
    const fbDiv = document.createElement("div");
    fbDiv.innerHTML = `
      <p><strong>${data.employeeName || 'Unknown Employee'}</strong></p>
      <p>Task: ${data.task} <br> Feedback: ${data.feedback}</p>
      <p>Status: ${data.approved ? "✅ Approved" : "❌ Pending"}</p>
      ${!data.approved ? `<button class="approve-feedback-btn" data-id="${doc.id}">Approve</button>` : ""}
      <hr>`;
    taskFeedbackContainer.appendChild(fbDiv);
  }

  // Approve user buttons
  document.querySelectorAll(".approve-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const id = e.target.getAttribute("data-id");
      await updateDoc(doc(db, "users", id), { approved: true });
      alert("User approved!");
      location.reload();
    });
  });

  // Approve leave requests
  document.querySelectorAll(".approve-leave-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const id = e.target.getAttribute("data-id");
      await updateDoc(doc(db, "leaveRequests", id), { approved: true });
      alert("Leave approved!");
      location.reload();
    });
  });

  // Approve task feedback
  document.querySelectorAll(".approve-feedback-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const id = e.target.getAttribute("data-id");
      await updateDoc(doc(db, "taskFeedback", id), { approved: true });
      alert("Task feedback approved!");
      location.reload();
    });
  });
});

document.getElementById("logoutBtn").addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "employee-portal.html";
});
</script>

<script type="module">
  // ... your Firebase setup remains

  // Assign Schedule
  document.getElementById("scheduleForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const userId = document.getElementById("employeeSelectSchedule").value;
    const details = document.getElementById("scheduleDetails").value;

    try {
      await addDoc(collection(db, "schedules", userId, "entries"), {
        details,
        timestamp: new Date(),
      });
      document.getElementById("scheduleMsg").textContent = "✅ Schedule assigned!";
    } catch (err) {
      console.error("Error adding schedule:", err);
      document.getElementById("scheduleMsg").textContent = "❌ Failed to assign schedule.";
    }
  });

  // Assign Leave
  document.getElementById("leaveForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const userId = document.getElementById("employeeSelectLeave").value;
    const details = document.getElementById("leaveDetails").value;

    try {
      await addDoc(collection(db, "leaves", userId, "entries"), {
        details,
        timestamp: new Date(),
      });
      document.getElementById("leaveMsg").textContent = "✅ Leave submitted!";
    } catch (err) {
      console.error("Error adding leave:", err);
      document.getElementById("leaveMsg").textContent = "❌ Failed to submit leave.";
    }
  });

  // Assign Duty
  document.getElementById("dutyForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const userId = document.getElementById("employeeSelectDuty").value;
    const details = document.getElementById("dutyDetails").value;

    try {
      await addDoc(collection(db, "duties", userId, "entries"), {
        details,
        timestamp: new Date(),
      });
      document.getElementById("dutyMsg").textContent = "✅ Duty assigned!";
    } catch (err) {
      console.error("Error assigning duty:", err);
      document.getElementById("dutyMsg").textContent = "❌ Failed to assign duty.";
    }
  });
</script>


</head>
<body>
  <header class="portal-header">
    <h1>Admin Dashboard</h1>
    <button id="logoutBtn" class="gold-button" style="float:right; margin-right: 20px;">Logout</button>
  </header>

  <main class="portal-container">
    <nav class="tabs-nav">
      <button class="tab-btn active" data-tab="manageEmployeesTab">Manage Employees</button>
      <button class="tab-btn" data-tab="assignSchedulesTab">Assign Schedules</button>
      <button class="tab-btn" data-tab="leaveManagementTab">Leaves & Offs</button>
      <button class="tab-btn" data-tab="assignDutiesTab">Assign Duties</button>
      <button class="tab-btn" data-tab="reviewReportsTab">Review Reports</button>
      <button class="tab-btn" data-tab="reviewLeavesTab">Leave Requests</button>
      <button class="tab-btn" data-tab="taskFeedbackTab">Task Feedback</button>
    </nav>

    <section id="manageEmployeesTab" class="tab-content active">
      <h2>Manage Employees</h2>
      <div id="employeesList">Loading employees...</div>
        <h3>Pending Approvals</h3>
        <ul id="approvalList"></ul>
    </section>

    <section id="assignSchedulesTab" class="tab-content">
      <h2>Assign Schedules</h2>
      <form id="scheduleForm">
        <label for="employeeSelectSchedule">Select Employee</label>
        <select id="employeeSelectSchedule" required></select>

        <label for="scheduleDetails">Schedule Details</label>
        <textarea id="scheduleDetails" rows="4" required></textarea>

        <button type="submit" class="gold-button">Assign Schedule</button>
      </form>
      <div id="scheduleMsg"></div>
    </section>

    <section id="leaveManagementTab" class="tab-content">
      <h2>Manage Leaves & Offs</h2>
      <form id="leaveForm">
        <label for="employeeSelectLeave">Select Employee</label>
        <select id="employeeSelectLeave" required></select>

        <label for="leaveDetails">Leave/Off Details</label>
        <textarea id="leaveDetails" rows="4" required></textarea>

        <button type="submit" class="gold-button">Submit Leave/Off</button>
      </form>
      <div id="leaveMsg"></div>
    </section>

    <section id="assignDutiesTab" class="tab-content">
      <h2>Assign Duties</h2>
      <form id="dutyForm">
        <label for="employeeSelectDuty">Select Employee</label>
        <select id="employeeSelectDuty" required></select>

        <label for="dutyDetails">Duty Details</label>
        <textarea id="dutyDetails" rows="4" required></textarea>

        <button type="submit" class="gold-button">Assign Duty</button>
      </form>
      <div id="dutyMsg"></div>

      <!-- ✅ Review Reports Tab -->
<section id="reviewReportsTab" class="tab-content">
  <h2>Submitted Reports</h2>
  <div id="reportsContainer">Loading reports...</div>
</section>

<!-- ✅ Review Leaves Tab -->
<section id="reviewLeavesTab" class="tab-content">
  <h2>Leave / Off Requests</h2>
  <div id="leaveRequestsContainer">Loading leave requests...</div>
</section>

<!-- ✅ Task Feedback Tab -->
<section id="taskFeedbackTab" class="tab-content">
  <h2>Task Feedback</h2>
  <div id="taskFeedbackContainer">Loading task feedback...</div>
</section>

  </main>
  <script>
  // Tab functionality
  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabContents = document.querySelectorAll(".tab-content");

  tabButtons.forEach(button => {
    button.addEventListener("click", () => {
      const targetTab = button.getAttribute("data-tab");

      // Remove active class from all buttons and contents
      tabButtons.forEach(btn => btn.classList.remove("active"));
      tabContents.forEach(tab => tab.classList.remove("active"));

      // Add active class to clicked button and corresponding content
      button.classList.add("active");
      document.getElementById(targetTab).classList.add("active");
    });
  });
</script>

</body>
</html>
